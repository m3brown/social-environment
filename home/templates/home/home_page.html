{% extends "base.html" %}
{% load staticfiles %}

{% block body_class %}template-homepage{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<style>
html, body, #map {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
}
#map {
    position: relative;
}

</style>
{% endblock %}


{% block content %}
<div id="map"></div>

<input type="input" style="z-index: 10000; position: absolute; top: 10px; width: 50%; left: 50px;" />
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="{% static 'js/leaflet.markercluster-src.js' %}"></script>
<script>
var map;
var markers;
var current_url = window.location.href;
var arr = current_url.split("/");
var base_url = arr[0] + "//" + arr[2];
console.log(base_url);

var load_air_quality = function(bounds, load_func){
	var url = base_url;
	url = url + '/api/v1/airquality/?';
	url = url + 'min_latitude='+sw.lat+'&max_latitude='+ne.lat+"&";
	url = url + 'min_longitude='+ne.lng+'&max_longitude='+sw.lng;
	$.ajax(url)
	.done(function(data){
		var data_set = data.results;
		for(var lcv=0;lcv<data_set.length;lcv++){
			var data_point = data_set[lcv];
			var marker = L.marker([data_point.Latitude, data_point.Longitude]);
			markers.addLayer(marker);
		}
		console.log("added ", data.results.length, "objects to map");
	});
};
var load_air_quality_to_map = function(bounds){
	var ne = bounds._northEast;
	var sw = bounds._southWest;
	var url = base_url;
	url = url + '/api/v1/airquality/?';
	url = url + 'min_latitude='+sw.lat+'&max_latitude='+ne.lat+"&";
	url = url + 'min_longitude='+ne.lng+'&max_longitude='+sw.lng;
	$.ajax(url)
	.done(function(data){
		var data_set = data.results;
		for(var lcv=0;lcv<data_set.length;lcv++){
			var data_point = data_set[lcv];
			var marker = L.marker([data_point.Latitude, data_point.Longitude]);
			markers.addLayer(marker);
		}
		console.log("added ", data.results.length, "objects to map");
	});
};

var load_toxic_to_map = function(bounds){
	var ne = bounds._northEast;
	var sw = bounds._southWest;
	var url = 'http://localhost:8000';
	url = url + '/api/v1/toxic/?';
	url = url + 'min_latitude='+sw.lat+'&max_latitude='+ne.lat+"&";
	url = url + 'min_longitude='+ne.lng+'&max_longitude='+sw.lng;
	$.ajax(url)
	.done(function(data){
		var data_set = data.results;
		for(var lcv=0;lcv<data_set.length;lcv++){
			var data_point = data_set[lcv];
			var marker = L.marker([data_point.LATITUDE, data_point.LONGITUDE]);
			markers.addLayer(marker);
		}
		console.log("added ", data.results.length, "objects to map");
	});

};
var initializeMap = function(position){
	map = L.map('map').setView([position.coords.latitude, position.coords.longitude], 13);

	L.tileLayer('https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoidmNjYWJyYWwiLCJhIjoiY2lpNWZpMXV3MDFnaXR3a2Z4cWhtOHIzdCJ9.VrZvhWnHZmXBxdJf1XWitQ', {
	    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
	    maxZoom: 18,
	    id: 'your.mapbox.project.id',
	    accessToken: 'your.mapbox.public.access.token'
	}).addTo(map);

	L.marker(
		[position.coords.latitude, position.coords.longitude],
		{"title": "Me"}

	).addTo(map);

	markers = L.markerClusterGroup({
		maxClusterRadius: 120,
		iconCreateFunction: function (cluster) {
			var markers = cluster.getAllChildMarkers();
			var n = 0;
			for (var i = 0; i < markers.length; i++) {
				n += markers[i].number;
			}
			return L.divIcon({ html: n, className: 'mycluster', iconSize: L.point(40, 40) });
		},
		//Disable all of the defaults:
		spiderfyOnMaxZoom: false, showCoverageOnHover: false, zoomToBoundsOnClick: false
	});
	markers.addTo(map);


	map.on('moveend', function(e){
		var bounds = map.getBounds();
		load_air_quality_to_map(bounds);
		load_toxic_to_map(bounds);
	});

}

var initialPosition = {
	"coords": {
		"latitude": 51.505,
		"longitude": -0.09
	}
};

if(navigator.geolocation){
	navigator.geolocation.getCurrentPosition(initializeMap);
}else{
	initializeMap(initialPosition);
}

</script>
{% endblock %}
