{% extends "base.html" %}
{% load staticfiles %}

{% block body_class %}template-homepage{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/leaflet.css' %}" />
<link rel="stylesheet" href="{% static 'css/MarkerCluster.css' %}"></script>
<link rel="stylesheet" href="{% static 'css/MarkerCluster.Default.css' %}" />
<link ref="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
<link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
<style>
html, body, #map {width: 100%;height: 100%;margin: 0;padding: 0;}
#map {position: relative;}

.leaflet-control-mapbox-geocoder-results a {width: 250px;}
.leaflet-control-mapbox-geocoder-results a:hover {width: 250px;}
.leaflet-control-mapbox-geocoder-wrap{
	width: 250px;
}

</style>
{% endblock %}


{% block content %}

<select id="year" class="form-control" style="visibility: hidden;position: absolute; z-index:1000; left: 50px; top:20px;">
  <option selected="selected" value="2013">2013</option>
</select>

<div id="map"></div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="{% static 'js/leaflet.js' %}"></script>
<script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
<script src="{% static 'js/leaflet.markercluster-src.js' %}"></script>
<script>

var map;
var current_url = window.location.href;
var arr = current_url.split("/");
var base_url = arr[0] + "//" + arr[2];
var api_call_count = 0;
var marker_count = 0;
var duplicate_marker_count = 0;
var exists_markers = {"air": [],"toxic": [], "quality": []};
var marker_universe = {"air": {},"toxic": {}, "quality": {}};
var cirlce;

var load_from_url = function(url, render_method){
	$.ajax(url).done(render_method);
};


var air_quality_url_from_bounds = function(api_endpoint, bounds){
	var lat = (bounds._southWest.lat + bounds._northEast.lat) / 2.0;
	var lng = (bounds._southWest.lng + bounds._northEast.lng) / 2.0;
	var url = base_url + api_endpoint + 
		'?latitude=' + lat + 
		'&longitude=' + lng + 
		'&year=' + $("#year").val();
	return url;
};

var generic_url_from_bounds = function(api_endpoint, bounds){
	var url = base_url + api_endpoint + 
		'?min_latitude='+bounds._southWest.lat+'&max_latitude='+bounds._northEast.lat+
		'&min_longitude='+bounds._southWest.lng+'&max_longitude='+bounds._northEast.lng+
		"&year="+$("#year").val();
	return url;
}

var get_generic_load_method = function(api_endpoint, render_method, get_url_from_bounds){
	return function(bounds){
		var url = get_url_from_bounds(api_endpoint, bounds);

		$.ajax(url)
		.done(function(data){
			render_method(data);

			if(data.next){
				load_from_url(data.next, render_method);
			}	
		});
	}
};

var get_marker = function(data_point){
	var point = [
		parseFloat(data_point.latitude), 
		parseFloat(data_point.longitude)
	];
	marker = L.marker(
		point,
		{"title": data_point.title}).bindPopup(data_point.title);
	return marker;
};

var generate_render_method = function(historical_markers){
	return function(data){
		var year = $("#year").val();
		var local_markers = [];
		for(var lcv=0;lcv<data.results.length;lcv++){
			var pk = data.results[lcv].id
			if(!(pk in historical_markers)){
				historical_markers[pk] = true;
				var marker = get_marker(data.results[lcv]);
				local_markers.push(marker);
			}
		}
		if(data.results.length>0){
			marker_universe[data.results[0].universe][year].addLayers(local_markers);
		}
	}
}

var load_toxic_to_map = get_generic_load_method(
	'/api/v1/toxic/',
	generate_render_method(
		exists_markers['toxic']
	),
	generic_url_from_bounds
);

var load_air_quality_to_map = get_generic_load_method(
	'/api/v1/airquality/', 
	generate_render_method(
		exists_markers['air']
	),
	generic_url_from_bounds
);

var load_generic_quality_to_map = get_generic_load_method(
	'/api/v1/map_score/', 
	function(data){
		var year = $("#year").val();
		marker_universe[data.results[0].universe][year].clearLayers();
		var marker = get_marker(data.results[0]);
		marker_universe[data.results[0].universe][year].addLayer(marker);
	},
	air_quality_url_from_bounds
);

var all_load_methods = [
	// load_toxic_to_map, 
	// load_air_quality_to_map,
	load_generic_quality_to_map
];

var set_refresh_url = function(){
	var center = map.getCenter();
	location.hash = center.lat+"/"+center.lng+"/"+map.getZoom()+"/"+$("#year").val();
};

//function should take a factory to draw icons.

var create_universe = function(universe_name, year){
	if(!(year in marker_universe[universe_name])){
		marker_universe[universe_name][year] = L.markerClusterGroup({
	    	spiderfyOnMaxZoom: true,
	    	showCoverageOnHover: true,
	    	zoomToBoundsOnClick: true
		});

		marker_universe[universe_name][year].addTo(map);
	}
};

var load_markers_to_bounds = function(e){
	set_refresh_url();

	var year = $("#year").val();
	var bounds = map.getBounds();

	create_universe("air", year);
	create_universe("toxic", year);
	create_universe("quality", year);

	circle.setLatLng(map.getCenter());

	for(var i in all_load_methods){
		all_load_methods[i](bounds);
	}
};

var initializeMap = function(position){
	var center = [position.coords.latitude, position.coords.longitude]
	map = L.map('map').setView(center, position.zoom || 13);

	L.tileLayer('https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoidmNjYWJyYWwiLCJhIjoiY2lpNWZpMXV3MDFnaXR3a2Z4cWhtOHIzdCJ9.VrZvhWnHZmXBxdJf1XWitQ', {
	    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
	    minZoom: 10,
	    maxZoom: 12,
	    id: '28903289137890890',
	    accessToken: 'pk.eyJ1IjoidmNjYWJyYWwiLCJhIjoiY2lpNWZpMXV3MDFnaXR3a2Z4cWhtOHIzdCJ9.VrZvhWnHZmXBxdJf1XWitQ'
	}).addTo(map);

	L.mapbox.accessToken = 'pk.eyJ1IjoidmNjYWJyYWwiLCJhIjoiY2lpNWZpMXV3MDFnaXR3a2Z4cWhtOHIzdCJ9.VrZvhWnHZmXBxdJf1XWitQ';

	var geocoder = L.mapbox.geocoderControl('mapbox.places', {
        autocomplete: true,
        keepOpen: true
    });

	map.addControl(geocoder);
	geocoder.on('select', function(event){
		$(".leaflet-control-mapbox-geocoder-form").find("input").val(event.feature.place_name);
	});

	circle = L.circle(center, 3218.69); // two miles
	circle.addTo(map);

	map.on('moveend', load_markers_to_bounds);
	load_markers_to_bounds();
}

$("#year").change(function(event){
	var cur_year = $("#year").val();
	for (var universe in marker_universe){
		for(var year in marker_universe[universe]){
			if (cur_year != year){
				if (year in marker_universe[universe]){
					map.removeLayer(marker_universe[universe][year]);
				}
			}
			if (cur_year == year){
				if (year in marker_universe[universe]){
					marker_universe[universe][year].addTo(map);
				}
			}
		}
	}
	load_markers_to_bounds();
});

var initialPosition = {
	"coords": {
		"latitude": 38.902590,
		"longitude": -77.050175,
	},
	"zoom": 13
};

if(location.hash.length>1){
	initialPosition.coords.latitude = location.hash.split("/")[0].substring(1);
	initialPosition.coords.longitude = location.hash.split("/")[1];
	initialPosition.zoom = location.hash.split("/")[2];
	$("#year").val(location.hash.split("/")[3])
	initializeMap(initialPosition);
}
else if(navigator.geolocation){
	navigator.geolocation.getCurrentPosition(initializeMap);
}else{
	initializeMap(initialPosition);
}

</script>
{% endblock %}
