{% extends "base.html" %}
{% load staticfiles %}

{% block body_class %}template-homepage{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<link rel="stylesheet" href="{% static 'css/MarkerCluster.css' %}"></script>
<link rel="stylesheet" href="https://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.Default.css" />

<style>
html, body, #map {width: 100%;height: 100%;margin: 0;padding: 0;}
#map {position: relative;}
</style>
{% endblock %}


{% block content %}
<div id="map"></div>

<input type="input" id="info" style="z-index: 10000; position: absolute; top: 10px; width: 50%; left: 50px;" />
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="{% static 'js/leaflet.markercluster-src.js' %}"></script>
<script>
var map;
var markers;
var current_url = window.location.href;
var arr = current_url.split("/");
var base_url = arr[0] + "//" + arr[2];
var api_call_count = 0;
var marker_count = 0;
var duplicate_marker_count = 0;
var exists_markers = {
	"air": [],
	"toxic": []
};
var marker_universe = {
	"air": {},
	"toxic": {}
};

var set_marker_count = function(){
	$("#info").val(marker_count+"|"+duplicate_marker_count);
}

var load_from_url = function(url, render_method){
	$.ajax(url).done(render_method);
};

var get_generic_load_method = function(api_endpoint, render_method){
	return function(bounds){
		var url = base_url + api_endpoint + 
			'?min_latitude='+bounds._southWest.lat+'&max_latitude='+bounds._northEast.lat+
			'&min_longitude='+bounds._northEast.lng+'&max_longitude='+bounds._southWest.lng;

		$.ajax(url)
		.done(function(data){
			render_method(data);
			if(data.next){
				load_from_url(data.next, render_method);
			}	
		});
	}
};

var get_marker = function(data_point){
	var point = [
		parseFloat(data_point.latitude), 
		parseFloat(data_point.longitude)
	];
	return L.marker(
		point,
		{"title": data_point.title})
	.bindPopup(data_point.title);
};

var generate_render_method = function(historical_markers){
	return function(data){
		for(var lcv=0;lcv<data.results.length;lcv++){
			var pk = data.results[lcv].id
			var local_markers = [];
			if(!(pk in historical_markers)){
				historical_markers[pk] = true;
				var marker = get_marker(data.results[lcv]);
				local_markers.push(marker);
			}
			markers.addLayers(local_markers);
		}
	}
}

var render_toxic_data = generate_render_method(exists_markers['toxic']);
var load_toxic_to_map = get_generic_load_method('/api/v1/toxic/', render_toxic_data);

var render_air_data = generate_render_method(exists_markers['air']);
var load_air_quality_to_map = get_generic_load_method('/api/v1/airquality/', render_air_data);

var set_refresh_url = function(){
	var center = map.getCenter();
	location.hash = center.lat+"/"+center.lng+"/"+map.getZoom();
};
//function should take a factory to draw icons.
var load_markers_to_bounds = function(e){
	set_refresh_url();
	var bounds = map.getBounds();
	load_air_quality_to_map(bounds);
	load_toxic_to_map(bounds);
};

var initializeMap = function(position){
	map = L.map('map').setView([position.coords.latitude, position.coords.longitude], position.zoom || 13);

	L.tileLayer('https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoidmNjYWJyYWwiLCJhIjoiY2lpNWZpMXV3MDFnaXR3a2Z4cWhtOHIzdCJ9.VrZvhWnHZmXBxdJf1XWitQ', {
	    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
	    minZoom: 12,
	    maxZoom: 18,
	    id: '28903289137890890',
	    accessToken: 'pk.eyJ1IjoidmNjYWJyYWwiLCJhIjoiY2lpNWZpMXV3MDFnaXR3a2Z4cWhtOHIzdCJ9.VrZvhWnHZmXBxdJf1XWitQ'
	}).addTo(map);

	L.marker(
		[position.coords.latitude, position.coords.longitude],
		{"title": "Me"}

	).addTo(map);

	markers = L.markerClusterGroup({
    	spiderfyOnMaxZoom: true,
    	showCoverageOnHover: true,
    	zoomToBoundsOnClick: true
	});

	markers.addTo(map);

	map.on('moveend', load_markers_to_bounds);
	load_markers_to_bounds();
}

var initialPosition = {
	"coords": {
		"latitude": 38.902590,
		"longitude": -77.050175,
	},
	"zoom": 13
};

if(location.hash.length>1){
	initialPosition.coords.latitude = location.hash.split("/")[0].substring(1);
	initialPosition.coords.longitude = location.hash.split("/")[1];
	initialPosition.zoom = location.hash.split("/")[2];
	initializeMap(initialPosition);
}
else if(navigator.geolocation){
	navigator.geolocation.getCurrentPosition(initializeMap);
}else{
	initializeMap(initialPosition);
}

</script>
{% endblock %}
