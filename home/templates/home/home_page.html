{% extends "base.html" %}
{% load staticfiles %}

{% block body_class %}

{% endblock %}

{% block extra_css %}

<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : 'your-app-id',
      xfbml      : true,
      version    : 'v2.5'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>

<link rel="stylesheet" href="{% static 'css/leaflet.css' %}" />
<link rel="stylesheet" href="{% static 'css/MarkerCluster.css' %}"></script>
<link rel="stylesheet" href="{% static 'css/MarkerCluster.Default.css' %}" />
<link ref="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
<link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
<style>
html, body, #map {width: 100%;height: 100%;margin: 0;padding: 0;}
#map {position: relative;}

.leaflet-control-mapbox-geocoder-results a {width: 100%;}
.leaflet-control-mapbox-geocoder-results a:hover {width: 100%;}
.leaflet-control-mapbox-geocoder-wrap{
	width: 250px;
}

.background {
    fill: #FFFFFF;
    fill-opacity: 0.01;
}

.component {
    fill: #e1e1e1;
}

.component .label {
    font-family: Myriad, "Helvetic Neue", Helvetica, Arial;
    text-anchor: middle;
    fill: #0000FF;
}

.arc {
    stroke-weight:0.1;
    fill: #4e8fff;
}


.arc2 {
    stroke-weight:0.1;
    fill: #3660b0;
}


.label {
    font-family:  Myriad, "Helvetic Neue", Helvetica, Arial;
    text-anchor: middle;
}

.radial-svg {
    display: block;
    margin: 0 auto;
}

#div2 {
    width: 33%;
    height: 50px;
    box-sizing: border-box;
    float: left;
}

#div2 .arc {
    stroke-weight: 0.1;
}

</style>
{% endblock %}

{% block content %}

<select id="year" class="form-control" style="visibility: hidden;position: absolute; z-index:1000; left: 50px; top:20px;">
  <option selected="selected" value="2013">2013</option>
</select>


<!-- Your share button code -->

<div id="map"></div>

<div class="fb-share-button" style="position: absolute; z-index:1000;left: 30px; bottom:20px;"
	
	data-layout="button_count">
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="{% static 'js/leaflet.js' %}"></script>
<script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
<script src="{% static 'js/leaflet.markercluster-src.js' %}"></script>
<script type="text/javascript" src="{% static 'js/radialProgress.js' %}"></script>
<script type="text/javascript" src="{% static 'js/d3.min.js' %}"></script>
<script>

var map;
var current_url = window.location.href;
var arr = current_url.split("/");
var base_url = arr[0] + "//" + arr[2];
var api_call_count = 0;
var marker_count = 0;
var duplicate_marker_count = 0;
var exists_markers = {"air": [],"toxic": [], "quality": []};
var marker_universe = {"air": {},"toxic": {}, "quality": {}};
var cirlce;

var load_from_url = function(url, render_method){
	$.ajax(url).done(render_method);
};


var air_quality_url_from_bounds = function(api_endpoint, bounds){
	var lat = (bounds._southWest.lat + bounds._northEast.lat) / 2.0;
	var lng = (bounds._southWest.lng + bounds._northEast.lng) / 2.0;
	var url = base_url + api_endpoint + 
		'?latitude=' + lat + 
		'&longitude=' + lng + 
		'&year=' + $("#year").val();
	return url;
};

var generic_url_from_bounds = function(api_endpoint, bounds){
	var url = base_url + api_endpoint + 
		'?min_latitude='+bounds._southWest.lat+'&max_latitude='+bounds._northEast.lat+
		'&min_longitude='+bounds._southWest.lng+'&max_longitude='+bounds._northEast.lng+
		"&year="+$("#year").val();
	return url;
}

var get_generic_load_method = function(api_endpoint, render_method, get_url_from_bounds){
	return function(bounds){
		var url = get_url_from_bounds(api_endpoint, bounds);

		$.ajax(url)
		.done(function(data){
			render_method(data);

			if(data.next){
				load_from_url(data.next, render_method);
			}	
		});
	}
};
var percentColors = [
    { pct: 0.0, color: { r: 0xff, g: 0x00, b: 0 } },
    { pct: 0.5, color: { r: 0xff, g: 0xff, b: 0 } },
    { pct: 1.0, color: { r: 0x00, g: 0xff, b: 0 } } ];

var getColorForPercentage = function(pct) {
    for (var i = 1; i < percentColors.length - 1; i++) {
        if (pct < percentColors[i].pct) {
            break;
        }
    }
    var lower = percentColors[i - 1];
    var upper = percentColors[i];
    var range = upper.pct - lower.pct;
    var rangePct = (pct - lower.pct) / range;
    var pctLower = 1 - rangePct;
    var pctUpper = rangePct;
    var color = {
        r: Math.floor(lower.color.r * pctLower + upper.color.r * pctUpper),
        g: Math.floor(lower.color.g * pctLower + upper.color.g * pctUpper),
        b: Math.floor(lower.color.b * pctLower + upper.color.b * pctUpper)
    };
    return 'rgb(' + [color.r, color.g, color.b].join(',') + ')';
    // or output as hex if preferred
}  

var get_marker = function(data_point){
	var point = [
		parseFloat(data_point.latitude), 
		parseFloat(data_point.longitude)
	];

	var all_points = "";
	// all_points = all_points + "<div>";
	// if(data_point.results.length==0){
	// 	all_points = "No available data.";
	// }else{
	// 	for(var key in data_point.results){
	// 		all_points = all_points + data_point.results[key][2]+": "+data_point.results[key][1];
	// 		if(key < data_point.results){
	// 			all_points = all_points + "<br/>";
	// 		}
	// 	}
	// }
	// all_points = all_points +"</div>";
	var content = "<div style='height:150px;'>"+data_point.title+"<div id='div2'></div></div>"+all_points;
	var popup = L.popup()
    .setLatLng(map.getCenter())
    .setContent(content)
    .openOn(map);

	var div2=d3.select(document.getElementById('div2'));
    var rp2 = radialProgress(document.getElementById('div2'))
            .diameter(150)
            .value(data_point.grade)
            .render();

    $(".arc").css({'fill': getColorForPercentage(data_point.grade)})

	marker = L.marker(
		point,
		{"title": data_point.title}
	).bindPopup(popup).openPopup();


	return marker;
};

var generate_render_method = function(historical_markers){
	return function(data){
		var year = $("#year").val();
		var local_markers = [];
		for(var lcv=0;lcv<data.results.length;lcv++){
			var pk = data.results[lcv].id
			if(!(pk in historical_markers)){
				historical_markers[pk] = true;
				var marker = get_marker(data.results[lcv]);
				local_markers.push(marker);
			}
		}
		if(data.results.length>0){
			marker_universe[data.results[0].universe][year].addLayers(local_markers);
		}
	}
}

var load_toxic_to_map = get_generic_load_method(
	'/api/v1/toxic/',
	generate_render_method(
		exists_markers['toxic']
	),
	generic_url_from_bounds
);

var load_air_quality_to_map = get_generic_load_method(
	'/api/v1/airquality/', 
	generate_render_method(
		exists_markers['air']
	),
	generic_url_from_bounds
);

var load_generic_quality_to_map = get_generic_load_method(
	'/api/v1/map_score/', 
	function(data){
		var year = $("#year").val();
		marker_universe[data.results[0].universe][year].clearLayers();
		var marker = get_marker(data.results[0]);
		marker_universe[data.results[0].universe][year].addLayer(marker);
	},
	air_quality_url_from_bounds
);

var all_load_methods = [
	// load_toxic_to_map, 
	// load_air_quality_to_map,
	load_generic_quality_to_map
];

var set_refresh_url = function(){
	var center = map.getCenter();
	location.hash = center.lat+"/"+center.lng+"/"+map.getZoom()+"/"+$("#year").val();
};

//function should take a factory to draw icons.

var create_universe = function(universe_name, year){
	if(!(year in marker_universe[universe_name])){
		marker_universe[universe_name][year] = L.markerClusterGroup({
	    	spiderfyOnMaxZoom: true,
	    	showCoverageOnHover: true,
	    	zoomToBoundsOnClick: true
		});

		marker_universe[universe_name][year].addTo(map);
	}
};

var load_markers_to_bounds = function(e){
	set_refresh_url();

	var year = $("#year").val();
	var bounds = map.getBounds();

	create_universe("air", year);
	create_universe("toxic", year);
	create_universe("quality", year);

	circle.setLatLng(map.getCenter());

	for(var i in all_load_methods){
		all_load_methods[i](bounds);
	}
};

var initializeMap = function(position){
	var center = [position.coords.latitude, position.coords.longitude]
	var zoom = position.zoom || 13;
	map = L.map('map').setView(center, zoom);

	L.tileLayer('https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoidmNjYWJyYWwiLCJhIjoiY2lpNWZpMXV3MDFnaXR3a2Z4cWhtOHIzdCJ9.VrZvhWnHZmXBxdJf1XWitQ', {
	    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
	    minZoom: 9,
	    maxZoom: 13,
	    id: '28903289137890890',
	    accessToken: 'pk.eyJ1IjoidmNjYWJyYWwiLCJhIjoiY2lpNWZpMXV3MDFnaXR3a2Z4cWhtOHIzdCJ9.VrZvhWnHZmXBxdJf1XWitQ'
	}).addTo(map);

	L.mapbox.accessToken = 'pk.eyJ1IjoidmNjYWJyYWwiLCJhIjoiY2lpNWZpMXV3MDFnaXR3a2Z4cWhtOHIzdCJ9.VrZvhWnHZmXBxdJf1XWitQ';

	var geocoder = L.mapbox.geocoderControl('mapbox.places', {
        autocomplete: true,
        keepOpen: true
    });

	map.addControl(geocoder);
	geocoder.on('select', function(event){
		$(".leaflet-control-mapbox-geocoder-form").find("input").val(event.feature.place_name);
	});

	circle = L.circle(center, 3218.69); // two miles
	circle.addTo(map);

	map.on('dragend', load_markers_to_bounds);
	load_markers_to_bounds();
	// setTimeout(function(){ 
	// 	map.setZoom(z);
	// }, 100);
}

$("#year").change(function(event){
	var cur_year = $("#year").val();
	for (var universe in marker_universe){
		for(var year in marker_universe[universe]){
			if (cur_year != year){
				if (year in marker_universe[universe]){
					map.removeLayer(marker_universe[universe][year]);
				}
			}
			if (cur_year == year){
				if (year in marker_universe[universe]){
					marker_universe[universe][year].addTo(map);
				}
			}
		}
	}
	load_markers_to_bounds();
});

var initialPosition = {
	"coords": {
		"latitude": 38.902590,
		"longitude": -77.050175,
	},
	"zoom": 13
};

if(location.hash.length>1){
	initialPosition.coords.latitude = location.hash.split("/")[0].substring(1);
	initialPosition.coords.longitude = location.hash.split("/")[1];
	initialPosition.zoom = location.hash.split("/")[2];
	$("#year").val(location.hash.split("/")[3])
	initializeMap(initialPosition);
}
else if(navigator.geolocation){
	navigator.geolocation.getCurrentPosition(
		initializeMap,
		function(){
			console.log("fallback");
			initializeMap(initialPosition);
		},{timeout:2500});
}else{
	initializeMap(initialPosition);
}

</script>
{% endblock %}
